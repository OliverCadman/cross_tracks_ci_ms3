{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col s12 user-option-list top-level-background">
        <ul>
            <li>
                <i class="fas fa-search user-option-icon search-bar-icon"></i>
            </li>
            {% if session.user %}
            <li>
                <a href="{{url_for('tracks.add_track', username=session['user'])}}"><i
                        class="fas fa-plus-square user-option-icon"></i>
                    <p class="user-option hide-on-small-only">Add Your Tracks</p>
                </a>
            </li>
            <li>
                <a href="{{url_for('users.user_profile', username=session['user'])}}"><i
                        class="fas fa-user-circle user-option-icon"></i>
                    <p class="user-option hide-on-small-only">Your Profile</p>
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
</div>
<div class="browse-background">
<div id="opaque-overlay"></div>
    <div class="search-bar-wrapper" id="search-bar-wrapper">
        <div class="row">
            <div class="col s12">
                <i class="fas fa-times-circle" id="close-search-wrapper"></i>
            </div>
        </div>
        <div class="row">
            <div class="col s12">
                    <form action="{{url_for('tracks.search_track')}}" method="POST" id="search-tracks-form">
                        <div class="input-field">
                        <input type="text" name="search_input" id="search_input" class="search-input-mobile"
                            oninput="searchTracks()">
                            <label for="search_input">Search by Genre or Username</label>
                        </div>
                    </form>
            </div>
        </div>
        <div class="container results-container">
            <div class="row">
                <div class="results-wrapper">

                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col s12 section-header">
            <h1>Latest Tracks</h1>
            <div class="center-align">
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                {% for message in messages %}
                {{message}}
                {% endfor %}
                {% endif %}
                {% endwith %}

            </div>

        </div>
    </div>
    <div class="row">
        {% if tracks_and_users %}
        {% for track in tracks_and_users %}
        {% set username = track['user'][0]['username'] %}
        <div class="col m6 l4 hide-on-small-only">
            <div class="card horizontal z-depth-5">
                <div class="card-stacked">
                    <div class="card-content">
                        <span class="card-title no-wordbreak">{{track.track_name}}</span>
                        {% if session.user %}
                        {% if session.user in track.likes %}
                        <span><a href="{{url_for('tracks.like_track', track_id=track._id, username=session['user'])}}"
                                class="modal-trigger like_track"><i class="fas fa-star"
                                    id="like-track-icon"></i></a></span><span>&nbsp;{{track.likes_count if track.likes_count}}</span>
                        {% else %}
                        <span><a href="{{url_for('tracks.like_track', track_id=track._id, username=session['user'])}}"
                                class="modal-trigger like_track"><i class="far fa-star"
                                    id="like-track-icon"></i></a></span><span>&nbsp;{{track.likes_count if track.likes_count}}</span>
                        {% endif %}
                        {% else %}
                        <span><a href="{{url_for('users.login')}}" class="modal-trigger"><i
                                    class="far
                                    fa-star"></i></a></span><span>&nbsp;{{track.likes_count if track.likes_count}}</span>
                        {% endif %}
                        {% if track.comments|length > 0 %}
                        <span class="comment-count"><i class="fas fa-comment"></i>&nbsp;{{track.comments|length}}</span>
                        {% endif %}
                        <div class="card-information-wrapper">
                            <div class="track-card-information">
                                <p class="artist-name">
                                    {{track.artist_name}}
                                </p>
                                <p class="album-name">
                                    {{track.album_name}}
                                </p>
                            </div>
                            <div class="card-action">
                                <div class="more-info-btn">
                                    <a href="#track_modal_{{track._id}}" class="btn modal-trigger"><i
                                            class="fas fa-info-circle"><i class="fas fa-comment"></i></i></a>
                                    {% if username == session["user"] %}
                                    <a href="#" class="btn">Edit</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    {% if not track.image_url == '' %}
                    <img src="{{track.image_url}}" alt="Image of Cover Art for Track" class="track-image">
                    {% else %}
                    <img src="{{url_for('static', filename='images/design3.png')}}" alt="Image of Cover Art for Track"
                        class="track-image">
                    {% endif %}
                </div>
            </div>

        </div>
        <div class="col s12 hide-on-med-and-up">
            <div class="card z-depth-4">
                <div class="card-image">
                    {% if not track.image_url == '' %}
                    <img src="{{track.image_url}}" alt="Image of Cover Art for Track" class="track-image">
                    {% else %}
                    <img src="{{url_for('static', filename='images/design3.png')}}" alt="Image of Cover Art for Track"
                        class="track-image">
                    {% endif %}
                </div>
                <div class="card-title">
                    <span>{{track.track_name}}</span>
                </div>
                {% if session.user %}
                {% if session.user in track.likes %}
                <span><a href="{{url_for('tracks.like_track', track_id=track._id, username=session['user'])}}"
                        class="modal-trigger like_track"><i class="fas fa-star"
                            id="like-track-icon"></i></a></span><span>{{track.likes_count if track.likes_count}}</span>
                {% else %}
                <span><a href="{{url_for('tracks.like_track', track_id=track._id, username=session['user'])}}"
                        class="modal-trigger like_track"><i class="far fa-star"
                            id="like-track-icon"></i></a></span><span>{{track.likes_count if track.likes_count}}</span>
                {% endif %}
                {% else %}
                <span><a href="{{url_for('users.login')}}" class="modal-trigger"><i
                            class="far fa-star"></i></a></span><span>{{track.likes_count if track.likes_count}}</span>
                {% endif %}
                    {% if track.comments|length > 0 %}
                    <span class="comment-count"><i class="fas fa-comment"></i>&nbsp;{{track.comments|length}}</span>
                    {% endif %}
                <div class="card-content">
                    <p>{{track.artist_name}}</p>
                    <p>{{track.album_name}}</p>
                    <p>{{track.genre}}</p>
                </div>
                <div class="card-action">
                    <p>
                        <small>Added by:</small> {{username}}
                        {% if track['user'][0]['profile_image'] %}
                        <a href="{{url_for('users.user_profile', username=username)}}">
                            <img src="{{url_for('users.display_profile_image', filename=track['user'][0]['profile_image'])}}"
                                alt="User profile image" class="user-image-card">
                        </a>
                        {% else %}
                        <a href="{{url_for('users.user_profile', username=username)}}">
                            <img src="{{url_for('static', filename='images/default-user-image.png')}}"
                                alt="User profile image" class="user-image-card">
                        </a>
                        {% endif %}
                    </p>
                    <a href="#track_modal_{{track._id}}" class="btn modal-trigger">More Info</a>
                    {% if username == session["user"] %}
                    <a href="#" class="btn">Edit</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="modal track-modal" id="track_modal_{{track._id}}">
            <i class="fas fa-times-circle modal-close close-modal-icon" data-group="close-modal"></i>
            <div class="modal-content">
                <div class="modal-header">
                    <div class="row">
                        <div class="col s12 modal-user-details">
                            <p>
                                <small>Added by:</small> {{username}}
                                {% if track['user'][0]['profile_image'] %}
                                <a href="{{url_for('users.user_profile', username=username)}}">
                                    <img src="{{url_for('users.display_profile_image', filename=track['user'][0]['profile_image'])}}"
                                        alt="User profile image" class="user-image-card">
                                </a>
                                {% else %}
                                <a href="{{url_for('users.user_profile', username=username)}}">
                                    <img src="{{url_for('static', filename='images/default-user-image.png')}}"
                                        alt="User profile image" class="user-image-card">
                                </a>
                                {% endif %}
                                <span class="message-user-modal"><a href="#" class="btn">Message {{username}}</a></span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                     <div class="row">
                         <div class="col s12 m6 album-cover-modal">
                             <h4 class="track-modal-header">{{track.track_name}}</h4>
                             {% if not track.image_url == '' %}
                             <img src="{{track.image_url}}" alt="Image of Cover Art for Track" class="album-cover">
                             {% else %}
                             <img src="{{url_for('static', filename='images/design3.png')}}"
                                 alt="Image of Cover Art for Track" class="album-cover">
                             {% endif %}
                         </div>
                         <div class="col s12 m6">
                             <p><span class="track-modal-info">Artist:</span> {{track.artist_name}}</p>
                             <p><span class="track-modal-info">Album:</span> {{track.album_name}}</p>
                             <p><span class="track-modal-info">Genre:</span> {{track.genre}}</p>
                             <p><span class="track-modal-info">Year of Release:</span> {{track.year_of_release}}</p>
                         </div>
                </div>
                    {% for comment_object in track["comments"]%}
                    <div class="col s12 m6 comments-container">
                        <div class="comments-wrapper">
                            <div class="comment">
                                <p>{{comment_object["comment"]}}</p>
                                <span
                                    class="date-comment-added"><small>{{comment_object["date_added"].strftime('%H:%M %Y-%m-%d')}}</small></span>
                            </div>
                            {% if track["comment_added_by"][0]["username"] == session.user %}
                            <div class="edit-delete-comment-btns">
                                <a href="#" id="edit-comment-btn"><i class="fas fa-edit"></i></a>
                                <a href="#"><i class="fas fa-trash-alt"></i></a>
                            </div>
                            {% endif %}
                        </div>
                        <hr class="comment-divider">
                    </div>
                    {% endfor %}
                    {% if session.user %}
                    <div class="col s12 m6 input-field add-comment-container">
                        <form action="{{url_for('tracks.add_comment', track_id=track._id, username=session['user'])}}"
                            method="POST">
                            <textarea rows="2" cols=10 name="comment_body" class="materialize-textarea"></textarea>
                            <label for="comment_body">Leave a comment:</label>
                            <div class="submit-comment-btn">
                                <button type="submit" class="btn right-align">Submit</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        <!-- Track Modal -->
        {% endif %}
    </div>
</div>






{% block scripts %}
<script src="{{url_for('static', filename='js/search-bar.js')}}"></script>
<script src="{{url_for('static', filename='js/edit-comment.js')}}"></script>
<script src="{{url_for('static', filename='js/profile_image_filesize_checker.js')}}"></script>
<script src="{{url_for('static', filename='js/like-button-ajax.js')}}"></script>
<script src="{{url_for('static', filename='js/comment-regex-error.js')}}"></script>
<script src="{{url_for('static', filename='js/fit-card-title.js')}}"></script>


{% endblock %}
<script>
    let submitButton = document.getElementById("search-submit-btn")

    function searchTracks() {
        inputField = document.getElementById("search_input")

        searchTrackURL = "{{url_for('tracks.search_track')}}"
        console.log(JSON.stringify(inputField.value))

        $.ajax({
            url: searchTrackURL,
            type: 'POST',
            contentType: 'application/json;charset=UTF-8',
            data: {
                'data': inputField.value
            },
            success: function (res) {
                let resultsWrapper = document.getElementsByClassName('results-wrapper')[0]
                empty(resultsWrapper)

                let results = res.results_list
                let newResults = res.new_results_list
                let user = res.user


                if (results) {
                    results.map((item, index) => {
                        if (item) {
                            console.log(item.likes.includes(user))
                            let resultDisplay = `
                            <div class="col s12">
                                <div class="card horizontal z-depth-5">
                                    <div class="card-stacked">
                                        <div class="card-content">
                                            <span class="card-title">${item.track_name}</span>
                                             ${item.likes.includes(String(user)) ? ` <span><a
                                                     href="{{url_for('tracks.like_track', track_id='${item._id}', username=session['user'])}}"
                                                     class="modal-trigger like_track"><i class="fas fa-star"
                                                         id="like-track-icon"></i></a></span><span>&nbsp;${item.likes_count
                                                 ? `${item.likes_count}` : ''}</span>` : ` <span><a
                                                         href="{{url_for('tracks.like_track', track_id='${item._id}', username=session['user'])}}"
                                                         class="modal-trigger like_track"><i class="far fa-star"
                                                             id="like-track-icon"></i></a></span><span>&nbsp;${item.likes_count
                                                     ? `${item.likes_count}` : ''}</span>` }
                                            <div class="card-information-wrapper">
                                        <div class="track-card-information">
                                            <p class="artist-name">${item.artist_name}</p>
                                            <p class="album-name">
                                                <p>${item.album_name}</p>
                                        </div>
                                        <p>${item.genre}</p>
                                </div>
                                <div class="card-action">
                                <div class="more-info-btn">
                                    <a href="#track_modal_{{'${item._id.$oid}'}}" class="btn modal-trigger"><i
                                            class="fas fa-info-circle"><i class="fas fa-comment"></i></i></a>
                                    {% if username == session["user"] %}
                                    <a href="#" class="btn">Edit</a>
                                    {% endif %}
                                </div>
                                </div>
                                </div>
                                </div>
                                 <div>
                                     ${item.image_url ? `<img src=${item.image_url} alt="Image of Cover Art for Track"
                                         class="track-image">` : `<img
                                         src="{{url_for('static', filename='images/design3.png')}}"
                                         alt="Image of Cover Art for Track" class="track-image">`}
                                 </div>
                                </div>

                                </div>
                            `
                            resultsWrapper.innerHTML += resultDisplay
                            let searchActive = false;
                        } else {
                            console.log("item length: ", item.length)
                            console.log('done')
                        }
                    })
                } else if (newResults) {

                }



            },
            error: function (err) {
                console.log(err)
            }
        });

        // https://stackoverflow.com/questions/27108725/ajax-jquery-live-search-is-duplicating-the-output-results
        function empty(element) {
            let children = Array.prototype.slice.call(element.childNodes);

            children.forEach(function (child) {
                element.removeChild(child)
            })
        }

    };
</script>


{% endblock %}